#!/usr/bin/env node

const program = require('commander')
const colors = require('colors')
const fs = require('fs')
const pkg = require('../package.json')
const Extractor = require('../scripts/extractor')
const pull = require('../scripts/pull')
const compile = require('../scripts/compile')
const push = require('../scripts/push')

const logError = err => {
	console.error(colors.red(err))
}

program.version(pkg.version)

program
	.command('extract [files] [outputDir]')
	.option('-d, --domain <domain>', 'Default domain', 'elium')
	.option('-l, --lang <lang>', 'Default language', 'en')
	.action(async (files, outputDir, options) => {
		if (!files) {
			logError('Missing files glob')
			process.exit(1)
		}
		if (!outputDir) {
			logError('Missing output directory')
			process.exit(1)
		}

		const extractor = new Extractor(options.domain, options.language)
		await extractor.process(files)
		extractor.toPOT(outputDir)
	})
	.on('--help', () => {
		console.log('Sentences to translate are extracted using our AST Parser that parses JS/JSX')
		console.log('files and match the following functions : i18n.t and t')
	})

program
	.command('pull')
	.option('-l, --language <language>', 'Language')
	.option('--source <source>', 'Source Language')
	.option('-b, --branch [branch]', 'Branch')
	.action(options => {
		if (!fs.existsSync('.tx/config')) {
			logError('No transifex configuration found in this directory. Please ensure you have a .tx/config file.')
			process.exit(1)
		}
		return pull(options)
	})
program
	.command('compile')
	.option('-s, --source <path>', 'Source PO directory')
	.option('-t, --target <path>', 'Target json directory')
	.action(options => compile(options))

program
	.command('push')
	.option('-b, --branch [branch]', 'Branch')
	.action(options => push(options))

program.parse(process.argv)

if (!program.args.length) program.help()
